#name: A workflow for my Hello World App
#on:
#  push:
#    branches:
#      - master
#      - develop
#
#permissions:
#  contents: write
#
#jobs:
#  UnitTests:
#    name: Unit Tests
#    runs-on: ubuntu-22.04
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#      - name: Set up JDK 18
#        uses: actions/setup-java@v2
#        with:
#          java-version: '18'
#          distribution: 'temurin'
#      - name: Unit Tests
#        run: mvn -Dtest=com.napier.sem.AppTest test
#
#  IntegrationTests:
#    name: Integration Tests
#    runs-on: ubuntu-22.04
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#      - name: Set up JDK 18
#        uses: actions/setup-java@v2
#        with:
#          java-version: '18'
#          distribution: 'temurin'
#      - name: Integration Tests
#        run: |
#          docker compose up -d db
#          mvn -Dtest=com.napier.sem.AppIntegrationTest test
#      - name: Shutdown
#        run: docker compose down
#      - name: CodeCov
#        uses: codecov/codecov-action@v5
#        with:
#          token: ${{ secrets.CODECOV_TOKEN }} # not required for public repos
#          directory: ./target/site/jacoco
#          flags: Integration Tests # optional
#          verbose: true # optional (default = false)
#  build:
#    name: Build and Start Using docker compose
#    runs-on: ubuntu-22.04
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#      - name: Set up JDK 18
#        uses: actions/setup-java@v2
#        with:
#          java-version: '18'
#          distribution: 'temurin'
#      - name: Package and Run docker compose
#        run: |
#          mvn package -DskipTests
#          docker compose up --abort-on-container-exit
#
#  name: Build Run in Docker and Deploy Release
#  runs-on: ubuntu-22.04
#  steps:
#    - name: Checkout
#      uses: actions/checkout@v4
#      with:
#        submodules: recursive
#    - name: Set up JDK 18
#      uses: actions/setup-java@v2
#      with:
#        java-version: '18'
#        distribution: 'adopt'
#    - name: Package and Run docker compose
#      run: |
#        mvn package -DskipTests
#        docker compose up --abort-on-container-exit
#    - uses: "marvinpinto/action-automatic-releases@latest"
#      with:
#        repo_token: "${{ secrets.GITHUB_TOKEN }}"
#        prerelease: false
#        automatic_release_tag: "latest"
#        files: |
#          ./target/devops.jar

name: A workflow for my Hello World App

on:
  push:
    branches:
      - master
      - develop

permissions:
  contents: write

jobs:
  UnitTests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 18
        uses: actions/setup-java@v4
        with:
          java-version: '18'
          distribution: 'temurin'

      - name: Unit Tests
        run: mvn -Dtest=com.napier.sem.AppTest test

  IntegrationTests:
    name: Integration Tests
    runs-on: ubuntu-22.04
    needs: UnitTests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 18
        uses: actions/setup-java@v4
        with:
          java-version: '18'
          distribution: 'temurin'

      - name: Start database (Docker Compose)
        run: docker compose up -d db

      - name: Integration Tests
        run: mvn -Dtest=com.napier.sem.AppIntegrationTest test

      - name: Shutdown Docker Compose
        run: docker compose down

      - name: CodeCov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # not required for public repos
          directory: ./target/site/jacoco
          flags: IntegrationTests
          verbose: true

  Build:
    name: Build and Start Using docker compose
    runs-on: ubuntu-22.04
    needs:
      - UnitTests
      - IntegrationTests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 18
        uses: actions/setup-java@v4
        with:
          java-version: '18'
          distribution: 'temurin'

      - name: Package and Run docker compose
        run: |
          mvn package -DskipTests
          docker compose up --abort-on-container-exit

  BuildAndRelease:
    name: Build Run in Docker and Deploy Release
    runs-on: ubuntu-22.04
    needs:
      - UnitTests
      - IntegrationTests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 18
        uses: actions/setup-java@v4
        with:
          java-version: '18'
          distribution: 'temurin'

      - name: Package and Run docker compose
        run: |
          mvn package -DskipTests
          docker compose up --abort-on-container-exit

      - name: Create automatic release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          automatic_release_tag: latest
          files: |
            ./target/devops.jar
